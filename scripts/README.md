# Scripts Documentation

## Xata Schema Management

### Overview

This project uses an automated system to keep Xata database schemas in sync and make it easy to initialize fresh databases.

### Key Files

- **xata-migrations.json** - Optimized migration history based on `schema.prisma` ✅ COMMITTED
- **prisma/schema.prisma** - Source of truth for database schema
- **scripts/xata-initialize.ts** - Initialize a fresh Xata database
- **scripts/sync-migrations.ts** - Sync optimized migrations (runs automatically)

### How It Works

```
┌──────────────────┐
│ Developer makes  │
│ schema changes   │
│ in Xata UI       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ npm run         │
│ prisma:pull      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Edit & commit    │
│ schema.prisma    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Pre-commit hook  │◄─── Husky detects schema.prisma changed
│ runs automatic   │
│ sync             │
└────────┬─────────┘
         │
         ├─► Pull latest from Xata (107 migrations)
         ├─► Optimize (107 → 19, ~82% reduction)
         ├─► Update xata-migrations.json
         └─► Add to commit

         ▼
┌───────────────────┐
│ Commit includes   │
│ both files:       │
│ - schema.prisma   │
│ - migrations.json │
└───────────────────┘
```

## Scripts

### `npm run schema:init`

**Purpose**: Initialize a fresh Xata database with your current schema

**When to use**:
- Setting up a new development environment
- Onboarding a new developer
- Creating staging/production databases
- After cloning the repository

**How it works**:
1. Reads `xata-migrations.json` (committed in git)
3. Database is ready to use!

**Example**:
```bash
# Clone repo
git clone <repo>
cd <repo>

# Install dependencies
npm install

# Set up Xata credentials
# (create .xatarc or set environment variables)

# Initialize database
npm run schema:init

# Done! Database has your complete schema
```

### `npm run sync:migrations`

**Purpose**: Sync optimized migrations with current schema (runs automatically)

**When it runs**:
- **Automatically** via pre-commit hook when `schema.prisma` is modified
- Manually if you need to force a sync

**How it works**:
1. Pulls latest migration history from Xata
2. Optimizes migrations (removes redundant operations)
3. Updates `xata-migrations.json`
4. Adds updated file to your commit

**Manual usage** (rarely needed):
```bash
npm run sync:migrations
```

## Workflow Examples

### Making Schema Changes

```bash
# 1. Make changes in Xata UI
#    (add tables, columns, etc.)

# 2. Pull latest schema
npm run prisma:pull

# 3. Transform and format
npm run schema-transform
npm run prisma:format

# 4. Commit changes
git add prisma/schema.prisma
git commit -m "feat: add new user fields"

# Pre-commit hook automatically:
# - Detects schema.prisma changed
# - Runs npm run sync:migrations
# - Updates xata-migrations.json
# - Adds it to your commit
#
# ✅ Both files committed together!
```

### Setting Up New Environment

```bash
# Clone and install
git clone <repo>
npm install

# Configure Xata
# Option 1: Create .xatarc
# Option 2: Set XATA_API_KEY and XATA_BRANCH env vars

# Initialize database
npm run schema:init

# Generate Prisma client
npm run prisma:generate

# Start development
npm run dev
```

## Benefits

### ✅ Always In Sync
- Pre-commit hook ensures `xata-migrations.json` never goes stale
- Impossible to commit `schema.prisma` without updating migrations

### ✅ Fast Initialization
- Only optimized migrations applied
- ~80% faster database setup
- No redundant operations

### ✅ No Manual Steps
- Automation handles everything
- Developers don't need to remember to sync
- Works seamlessly with existing git workflow

### ✅ Easy Onboarding
- New developers just run `npm run schema:init`
- No access to original database needed
- Complete schema from day one

### ✅ Clean Git History
- Only optimized migrations in git (19 vs 107)
- Smaller diffs, easier code reviews
- No migration pollution

## File Structure

```
project/
├── prisma/
│   └── schema.prisma                    # Source of truth (Prisma format)
├── xata-migrations.json                 # Optimized migrations (Xata format) ✅ COMMITTED
├── scripts/
│   ├── xata-initialize.ts               # Initialize fresh DB
│   ├── sync-migrations.ts               # Sync migrations (auto-run)
│   └── README.md                        # This file
└── .husky/
    └── pre-commit                       # Triggers sync on schema changes
```

## Configuration

### Environment Variables

```bash
# Option 1: Use .xatarc file (auto-generated by xata init)
{
  "databaseURL": "https://workspace.region.xata.sh/db/database"
}

# Option 2: Use environment variables
export XATA_API_KEY="xau_..."
export XATA_BRANCH="main"
export XATA_DATABASE_URL="https://..."
```

### Customize Branch

Edit `scripts/xata-initialize.ts` or `scripts/sync-migrations.ts`:

```typescript
const BRANCH = "main"; // Change to "dev", "staging", etc.
```

## Troubleshooting

### "Optimized migrations file not found"

**Problem**: Running `npm run schema:init` but file doesn't exist

**Solution**:
```bash
# Generate it manually
npm run sync:migrations
```

### "Failed to sync migrations. Commit aborted."

**Problem**: Pre-commit hook can't access Xata

**Solutions**:
1. Check `.xatarc` exists and is correct
2. Verify Xata credentials are valid
3. Ensure network connectivity to Xata
4. Skip hook if needed: `git commit --no-verify` (not recommended)

### "No access to this workspace"

**Problem**: Xata credentials not configured

**Solution**:
```bash
# Login to Xata
xata auth login

# Or create .xatarc manually
# Or set XATA_API_KEY environment variable
```

## Technical Details

### Migration Optimization

The optimization process:

1. **Analyzes** all 107 migrations chronologically
2. **Tracks** final state of each table and column
3. **Eliminates** redundant operations:
   - Columns added then removed
   - Multiple renames of same column
   - Tables created and dropped
   - Intermediate modifications
4. **Generates** minimal migration set (19 migrations)
5. **Preserves** all metadata (triggers, constraints, foreign keys)

### Pre-commit Hook

Located in `.husky/pre-commit`:

```bash
# Only runs if schema.prisma is being committed
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
  npm run sync:migrations || exit 1
fi
```

## Other Scripts

- **env-replace.ts**: Environment variable replacement
- **load-secrets.ts**: Load secrets from Infisical
- **load-secrets-ci.ts**: Load secrets in CI/CD
- **reload-secrets.ts**: Reload secrets
- **schema-transform.ts**: Transform Prisma schema
- **sync-branch-schema.ts**: Sync branch schema
- **xata-migration.ts**: Xata migration utilities
- **helpers.ts**: Shared helper functions

## FAQ

**Q: Do I need to run `sync:migrations` manually?**
A: No! It runs automatically via pre-commit hook when you commit schema.prisma changes.

**Q: What if I forget to pull schema changes before committing?**
A: The pre-commit hook will sync based on your Xata database, so you'll get the latest schema automatically.

**Q: Can I initialize multiple databases (dev, staging, prod)?**
A: Yes! Just configure different `.xatarc` files or environment variables for each, then run `npm run schema:init`.

**Q: Is the optimized file safe to commit?**
A: Yes! It's the source of truth for initializing databases. Keep it in git.

**Q: What if the pre-commit hook fails?**
A: Fix your Xata credentials or network issues. Don't use `--no-verify` as it will cause migrations to go out of sync.
