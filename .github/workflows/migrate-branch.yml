name: Xata migrate branch

on:
  workflow_dispatch:
    inputs:
      baseBranch:
        description: "Base branch (source of migration)"
        required: true
        type: string
      targetBranch:
        description: "Target branch (destination of migration)"
        required: true
        type: choice
        options:
          - dev
          - test
          - main
      lastCommonMigrationId:
        description: "Last common migration ID (optional)"
        required: false
        type: string
        default: ""

jobs:
  migrate_branch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Validate branch inputs
        run: |
          if [ "${{ github.event.inputs.baseBranch }}" == "${{ github.event.inputs.targetBranch }}" ]; then
            echo "Error: Base branch and target branch cannot be the same"
            exit 1
          fi

      - name: Determine NODE_ENV for base branch
        id: env
        run: |
          if [ "${{ github.event.inputs.baseBranch }}" == "main" ]; then
            echo "node_env=production" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.baseBranch }}" == "test" ]; then
            echo "node_env=test" >> $GITHUB_OUTPUT
          else
            echo "node_env=dev" >> $GITHUB_OUTPUT
          fi

      - name: Load Secrets in Env
        run: |
          npx tsx ./scripts/load-secrets-ci
        env:
          NODE_ENV: ${{ steps.env.outputs.node_env }}
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}

      - name: Migrate DB schema from ${{ github.event.inputs.baseBranch }} to ${{ github.event.inputs.targetBranch }}
        run: |
          npx tsx ./scripts/xata-migration ${{ github.event.inputs.baseBranch }} ${{ github.event.inputs.targetBranch }} ${{ github.event.inputs.lastCommonMigrationId }}
        env:
          FORCE: true
